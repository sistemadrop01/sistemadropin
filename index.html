<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>ERP DROP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 flex">

  <!-- Sidebar -->
  <aside class="w-64 bg-gray-900 text-white min-h-screen p-4">
    <h1 class="text-2xl font-bold mb-8">DROP ERP</h1>
    <nav class="space-y-2">
      <button onclick="mostrar('dashboard')" class="w-full text-left p-2 rounded hover:bg-gray-700">üìä Dashboard</button>
      <button onclick="mostrar('produtos')" class="w-full text-left p-2 rounded hover:bg-gray-700">üì¶ Produtos</button>
      <button onclick="mostrar('fornecedores')" class="w-full text-left p-2 rounded hover:bg-gray-700">üè¢ Fornecedores</button>
      <button onclick="mostrar('vendas')" class="w-full text-left p-2 rounded hover:bg-gray-700">üí∞ Vendas</button>
      <button onclick="mostrar('financeiro')" class="w-full text-left p-2 rounded hover:bg-gray-700">üíµ Financeiro</button>
      <button onclick="mostrar('upload')" class="w-full text-left p-2 rounded hover:bg-gray-700">üìÇ Upload UPSELLER</button>
    </nav>
  </aside>

  <!-- Conte√∫do -->
  <main class="flex-1 p-6 space-y-6">

    <!-- DASHBOARD -->
    <section id="dashboard" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
      <div class="grid grid-cols-3 gap-4">
        <div class="bg-white shadow rounded-lg p-4 text-center">
          <p class="text-gray-500">Produtos em Estoque</p>
          <h3 id="qtdProdutos" class="text-2xl font-bold">0</h3>
        </div>
        <div class="bg-white shadow rounded-lg p-4 text-center">
          <p class="text-gray-500">Vendas (7 dias)</p>
          <h3 id="vendasSemana" class="text-2xl font-bold">0</h3>
        </div>
        <div class="bg-white shadow rounded-lg p-4 text-center">
          <p class="text-gray-500">Saldo Financeiro</p>
          <h3 id="saldoFinanceiro" class="text-2xl font-bold">R$ 0,00</h3>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4 mt-6">
        <div class="bg-white shadow rounded-lg p-4">
          <h3 class="font-semibold mb-2">Vendas por Produto</h3>
          <canvas id="graficoVendas"></canvas>
        </div>
        <div class="bg-white shadow rounded-lg p-4">
          <h3 class="font-semibold mb-2">Financeiro</h3>
          <canvas id="graficoFinanceiro"></canvas>
        </div>
      </div>
    </section>

    <!-- PRODUTOS -->
    <section id="produtos" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Gerenciar Produtos</h2>
      <form id="formProduto" class="space-y-4 max-w-2xl mb-6">
        <input type="hidden" id="produtoId">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <input id="sku" placeholder="SKU" class="p-2 border rounded">
          <select id="modelo" class="p-2 border rounded">
            <option value="Camiseta">Camiseta</option>
            <option value="Moletom">Moletom</option>
            <option value="Cal√ßa">Cal√ßa</option>
            <option value="Cal√ßado">Cal√ßado</option>
          </select>
          <input id="categoria" placeholder="Categoria" class="p-2 border rounded">
          <input id="cor" placeholder="Cor" class="p-2 border rounded">
          <input id="tamanho" placeholder="Tamanho" class="p-2 border rounded">
          <input type="number" id="quantidade" placeholder="Qtd" class="p-2 border rounded">
          <input type="number" step="0.01" id="precoFornecedor" placeholder="Pre√ßo Fornecedor" class="p-2 border rounded">
          <input type="number" step="0.01" id="precoVenda" placeholder="Pre√ßo Venda" class="p-2 border rounded">
        </div>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button>
      </form>
      <table class="w-full bg-white shadow rounded-lg" id="tabelaProdutos"></table>
    </section>

    <!-- FORNECEDORES -->
    <section id="fornecedores" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Fornecedores</h2>
      <form id="formFornecedor" class="space-y-4 max-w-2xl mb-6">
        <input type="hidden" id="fornecedorId">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <input id="nomeFornecedor" placeholder="Nome" class="p-2 border rounded">
          <input id="telefoneFornecedor" placeholder="Telefone" class="p-2 border rounded">
          <input id="emailFornecedor" placeholder="E-mail" class="p-2 border rounded">
          <input id="documentoFornecedor" placeholder="CPF/CNPJ" class="p-2 border rounded">
        </div>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button>
      </form>
      <table class="w-full bg-white shadow rounded-lg" id="tabelaFornecedores"></table>
    </section>

    <!-- VENDAS -->
    <section id="vendas" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Registrar Vendas</h2>
      <form id="formVendas" class="space-y-4 max-w-2xl mb-6">
        <input type="hidden" id="vendaId">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <input id="skuVenda" placeholder="SKU Produto" class="p-2 border rounded">
          <input type="number" id="quantidadeVenda" placeholder="Quantidade" class="p-2 border rounded">
          <input type="number" step="0.01" id="precoVendaUnit" placeholder="Pre√ßo Unit√°rio" class="p-2 border rounded">
        </div>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button>
      </form>
      <table class="w-full bg-white shadow rounded-lg" id="tabelaVendas"></table>
    </section>

    <!-- FINANCEIRO -->
    <section id="financeiro" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Financeiro</h2>
      <form id="formFinanceiro" class="space-y-4 max-w-2xl mb-6">
        <input type="hidden" id="financeiroId">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <select id="tipoLancamento" class="p-2 border rounded">
            <option value="Entrada">Entrada</option>
            <option value="Saida">Sa√≠da</option>
          </select>
          <input id="descricaoLancamento" placeholder="Descri√ß√£o" class="p-2 border rounded">
          <input type="number" step="0.01" id="valorLancamento" placeholder="Valor" class="p-2 border rounded">
        </div>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button>
      </form>
      <table class="w-full bg-white shadow rounded-lg" id="tabelaFinanceiro"></table>
    </section>

    <!-- UPLOAD UPSELLER -->
    <section id="upload" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Upload Planilha UPSELLER</h2>
      <input type="file" id="fileUpload" class="mb-4">
      <button onclick="processarPlanilha()" class="bg-green-600 text-white px-4 py-2 rounded">Processar</button>
      <div id="resultadoUpload" class="mt-4"></div>
    </section>

  </main>

  <script>
    // ====== CONFIG: Supabase ======
    const SUPABASE_URL = "https://ifkounurhfzwypnkywzz.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlma291bnVyaGZ6d3lwbmt5d3p6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MjczMDQsImV4cCI6MjA3MTIwMzMwNH0.0yHrecXrnPByyP2gFFvRI76r918Q4VQZxuHq7xz_neI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ====== Navega√ß√£o ======
    function mostrar(secao) {
      document.querySelectorAll("main section").forEach(s => s.classList.add("hidden"));
      document.getElementById(secao).classList.remove("hidden");
      if (secao === "dashboard") carregarDashboard();
      if (secao === "produtos") carregarProdutos();
      if (secao === "fornecedores") carregarFornecedores();
      if (secao === "vendas") carregarVendas();
      if (secao === "financeiro") carregarFinanceiro();
    }
    mostrar("dashboard");

    // ======================================================
    // DASHBOARD
    async function carregarDashboard() {
      // Produtos
      let { data: produtos } = await supabase.from("produtos").select("quantidade");
      const qtd = produtos?.reduce((s, p) => s + (p.quantidade || 0), 0) || 0;
      document.getElementById("qtdProdutos").textContent = qtd;

      // Vendas √∫ltimos 7 dias
      let { data: vendas } = await supabase.from("vendas").select("data, quantidade");
      const ultimos7 = vendas?.filter(v => (new Date() - new Date(v.data)) / (1000*60*60*24) <= 7) || [];
      document.getElementById("vendasSemana").textContent = ultimos7.reduce((s,v) => s + v.quantidade, 0);

      // Financeiro saldo
      let { data: financeiro } = await supabase.from("financeiro").select("tipo, valor");
      let saldo = 0;
      financeiro?.forEach(f => saldo += f.tipo === "Entrada" ? f.valor : -f.valor);
      document.getElementById("saldoFinanceiro").textContent = `R$ ${saldo.toFixed(2)}`;

      // Gr√°fico Vendas
      new Chart(document.getElementById("graficoVendas"), {
        type: "bar",
        data: {
          labels: ultimos7.map(v => new Date(v.data).toLocaleDateString("pt-BR")),
          datasets: [{ label: "Qtd", data: ultimos7.map(v => v.quantidade), backgroundColor: "blue" }]
        }
      });

      // Gr√°fico Financeiro
      new Chart(document.getElementById("graficoFinanceiro"), {
        type: "line",
        data: {
          labels: financeiro?.map(f => f.tipo) || [],
          datasets: [{ label: "R$", data: financeiro?.map(f => f.valor) || [], borderColor: "green", fill: false }]
        }
      });
    }

    // ======================================================
    // PRODUTOS
    async function carregarProdutos() {
      const { data } = await supabase.from("produtos").select("*");
      const tabela = document.getElementById("tabelaProdutos");
      tabela.innerHTML = "<tr class='bg-gray-200'><th>SKU</th><th>Modelo</th><th>Categoria</th><th>Qtd</th><th>A√ß√µes</th></tr>";
      data?.forEach(p => {
        tabela.innerHTML += `<tr>
          <td>${p.sku}</td><td>${p.modelo}</td><td>${p.categoria}</td><td>${p.quantidade}</td>
          <td>
            <button onclick="editarProduto(${p.id})" class="text-blue-600">Editar</button> | 
            <button onclick="excluirProduto(${p.id})" class="text-red-600">Excluir</button>
          </td>
        </tr>`;
      });
    }
    document.getElementById("formProduto").onsubmit = async (e) => {
      e.preventDefault();
      const id = document.getElementById("produtoId").value;
      const produto = {
        sku: sku.value, modelo: modelo.value, categoria: categoria.value, cor: cor.value,
        tamanho: tamanho.value, quantidade: parseInt(quantidade.value), 
        preco_fornecedor: parseFloat(precoFornecedor.value), preco_venda: parseFloat(precoVenda.value)
      };
      if (id) await supabase.from("produtos").update(produto).eq("id", id);
      else await supabase.from("produtos").insert([produto]);
      e.target.reset(); document.getElementById("produtoId").value = "";
      carregarProdutos();
    };
    async function editarProduto(id) {
      const { data } = await supabase.from("produtos").select("*").eq("id", id).single();
      Object.keys(data).forEach(k => { if(document.getElementById(k)) document.getElementById(k).value = data[k]; });
      document.getElementById("produtoId").value = id;
    }
    async function excluirProduto(id) {
      await supabase.from("produtos").delete().eq("id", id);
      carregarProdutos();
    }

    // ======================================================
    // FORNECEDORES
    async function carregarFornecedores() {
      const { data } = await supabase.from("fornecedores").select("*");
      const tabela = document.getElementById("tabelaFornecedores");
      tabela.innerHTML = "<tr class='bg-gray-200'><th>Nome</th><th>Telefone</th><th>Email</th><th>Documento</th><th>A√ß√µes</th></tr>";
      data?.forEach(f => {
        tabela.innerHTML += `<tr>
          <td>${f.nome}</td><td>${f.telefone}</td><td>${f.email}</td><td>${f.documento}</td>
          <td>
            <button onclick="editarFornecedor(${f.id})" class="text-blue-600">Editar</button> | 
            <button onclick="excluirFornecedor(${f.id})" class="text-red-600">Excluir</button>
          </td>
        </tr>`;
      });
    }
    document.getElementById("formFornecedor").onsubmit = async (e) => {
      e.preventDefault();
      const id = document.getElementById("fornecedorId").value;
      const fornecedor = {
        nome: nomeFornecedor.value, telefone: telefoneFornecedor.value,
        email: emailFornecedor.value, documento: documentoFornecedor.value
      };
      if (id) await supabase.from("fornecedores").update(fornecedor).eq("id", id);
      else await supabase.from("fornecedores").insert([fornecedor]);
      e.target.reset(); document.getElementById("fornecedorId").value = "";
      carregarFornecedores();
    };
    async function editarFornecedor(id) {
      const { data } = await supabase.from("fornecedores").select("*").eq("id", id).single();
      nomeFornecedor.value = data.nome; telefoneFornecedor.value = data.telefone;
      emailFornecedor.value = data.email; documentoFornecedor.value = data.documento;
      fornecedorId.value = id;
    }
    async function excluirFornecedor(id) {
      await supabase.from("fornecedores").delete().eq("id", id);
      carregarFornecedores();
    }

    // ======================================================
    // VENDAS
    async function carregarVendas() {
      const { data } = await supabase.from("vendas").select("*, produtos(sku)").order("data", { ascending: false });
      const tabela = document.getElementById("tabelaVendas");
      tabela.innerHTML = "<tr class='bg-gray-200'><th>SKU</th><th>Qtd</th><th>Pre√ßo</th><th>Data</th></tr>";
      data?.forEach(v => {
        tabela.innerHTML += `<tr>
          <td>${v.produtos?.sku || "-"}</td><td>${v.quantidade}</td><td>R$ ${v.preco}</td><td>${new Date(v.data).toLocaleString()}</td>
        </tr>`;
      });
    }
    document.getElementById("formVendas").onsubmit = async (e) => {
      e.preventDefault();
      const sku = skuVenda.value, qtd = parseInt(quantidadeVenda.value), preco = parseFloat(precoVendaUnit.value);
      const { data: produto } = await supabase.from("produtos").select("id").eq("sku", sku).single();
      if (!produto) return alert("Produto n√£o encontrado");
      await supabase.rpc("registrar_venda", { p_produto_id: produto.id, p_quantidade: qtd, p_preco: preco, p_descricao: "Venda Manual" });
      e.target.reset(); carregarVendas();
    };

    // ======================================================
    // FINANCEIRO
    async function carregarFinanceiro() {
      const { data } = await supabase.from("financeiro").select("*").order("data", { ascending: false });
      const tabela = document.getElementById("tabelaFinanceiro");
      tabela.innerHTML = "<tr class='bg-gray-200'><th>Tipo</th><th>Descri√ß√£o</th><th>Valor</th><th>Data</th></tr>";
      data?.forEach(f => {
        tabela.innerHTML += `<tr>
          <td>${f.tipo}</td><td>${f.descricao}</td><td>R$ ${f.valor}</td><td>${new Date(f.data).toLocaleString()}</td>
        </tr>`;
      });
    }
    document.getElementById("formFinanceiro").onsubmit = async (e) => {
      e.preventDefault();
      await supabase.from("financeiro").insert([{ tipo: tipoLancamento.value, descricao: descricaoLancamento.value, valor: parseFloat(valorLancamento.value) }]);
      e.target.reset(); carregarFinanceiro();
    };

    // ======================================================
    // UPLOAD PLANILHA
    async function processarPlanilha() {
      const file = document.getElementById("fileUpload").files[0];
      if (!file) { alert("Selecione uma planilha!"); return; }
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data);
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet);
      let sucessos = 0, falhas = 0;
      for (const row of rows) {
        const sku = row.SKU || row.sku || row["C√≥digo"];
        const quantidade = row.Quantidade || row.qtd || row["Qtd. do Produto"];
        const preco = row.Preco || row["Pre√ßo Unit√°rio"] || 0;
        if (sku && quantidade) {
          try {
            const { data: produto } = await supabase.from("produtos").select("id").eq("sku", sku).single();
            if (!produto) throw new Error("Produto n√£o encontrado");
            await supabase.rpc("registrar_venda", { p_produto_id: produto.id, p_quantidade: parseInt(quantidade), p_preco: parseFloat(preco), p_descricao: "Venda UPSELLER" });
            sucessos++;
          } catch (err) {
            console.error("Falha:", row, err); falhas++;
          }
        } else { falhas++; }
      }
      document.getElementById("resultadoUpload").innerHTML = `<p class="text-green-600">Sucessos: ${sucessos}</p><p class="text-red-600">Falhas: ${falhas}</p>`;
      carregarDashboard();
    }
  </script>
</body>
</html>
