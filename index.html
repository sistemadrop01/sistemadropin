<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>ERP DROP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 flex">

  <!-- Sidebar -->
  <aside class="w-64 bg-gray-900 text-white min-h-screen p-4">
    <h1 class="text-2xl font-bold mb-8">DROP ERP</h1>
    <nav class="space-y-2">
      <button onclick="mostrar('dashboard')" class="w-full text-left p-2 rounded hover:bg-gray-700">üìä Dashboard</button>
      <button onclick="mostrar('produtos')" class="w-full text-left p-2 rounded hover:bg-gray-700">üì¶ Produtos</button>
      <button onclick="mostrar('fornecedores')" class="w-full text-left p-2 rounded hover:bg-gray-700">üè≠ Fornecedores</button>
      <button onclick="mostrar('compras')" class="w-full text-left p-2 rounded hover:bg-gray-700">üõí Compras</button>
      <button onclick="mostrar('vendas')" class="w-full text-left p-2 rounded hover:bg-gray-700">üí∞ Vendas</button>
      <button onclick="mostrar('financeiro')" class="w-full text-left p-2 rounded hover:bg-gray-700">üìë Financeiro</button>
      <button onclick="mostrar('upload')" class="w-full text-left p-2 rounded hover:bg-gray-700">üìÇ Upload UPSELLER</button>
    </nav>
  </aside>

  <!-- Conte√∫do -->
  <main class="flex-1 p-6 space-y-6">

    <!-- DASHBOARD -->
    <section id="dashboard" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
      <div class="grid grid-cols-3 gap-4">
        <div class="bg-white shadow rounded-lg p-4 text-center">
          <p class="text-gray-500">Produtos Cadastrados</p>
          <h3 id="totalProdutos" class="text-2xl font-bold">0</h3>
        </div>
        <div class="bg-white shadow rounded-lg p-4 text-center">
          <p class="text-gray-500">Estoque Total</p>
          <h3 id="estoqueTotal" class="text-2xl font-bold">0</h3>
        </div>
        <div class="bg-white shadow rounded-lg p-4 text-center">
          <p class="text-gray-500">Vendas na Semana</p>
          <h3 id="vendasSemana" class="text-2xl font-bold">0</h3>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4 mt-6">
        <div class="bg-white shadow rounded-lg p-4">
          <h3 class="font-semibold mb-2">Produtos Mais Vendidos</h3>
          <canvas id="graficoVendas"></canvas>
        </div>
        <div class="bg-white shadow rounded-lg p-4">
          <h3 class="font-semibold mb-2">Financeiro</h3>
          <canvas id="graficoFinanceiro"></canvas>
        </div>
      </div>
    </section>

    <!-- PRODUTOS -->
    <section id="produtos" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Gerenciar Produtos</h2>
      <form id="formProduto" class="space-y-4 max-w-2xl card mb-6">
        <input type="hidden" id="produtoId">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <input id="sku" placeholder="SKU" class="p-2 border rounded">
          <input id="nome" placeholder="Nome do Produto" class="p-2 border rounded">
          <input id="categoria" placeholder="Categoria" class="p-2 border rounded">
          <input id="cor" placeholder="Cor" class="p-2 border rounded">
          <input id="tamanho" placeholder="Tamanho" class="p-2 border rounded">
          <input type="number" id="quantidade" placeholder="Qtd" class="p-2 border rounded">
          <input type="number" step="0.01" id="precoFornecedor" placeholder="Pre√ßo Fornecedor" class="p-2 border rounded">
          <input type="number" step="0.01" id="precoVenda" placeholder="Pre√ßo Venda" class="p-2 border rounded">
        </div>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button>
      </form>
      <table class="w-full bg-white shadow rounded">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2">SKU</th>
            <th>Nome</th>
            <th>Qtd</th>
            <th>Pre√ßo Venda</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="listaProdutos"></tbody>
      </table>
    </section>

    <!-- FORNECEDORES -->
    <section id="fornecedores" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Gerenciar Fornecedores</h2>
      <form id="formFornecedor" class="space-y-4 max-w-xl card mb-6">
        <input type="hidden" id="fornecedorId">
        <input id="fornecedorNome" placeholder="Nome" class="w-full p-2 border rounded">
        <input id="fornecedorTelefone" placeholder="Telefone" class="w-full p-2 border rounded">
        <input id="fornecedorCnpjCpf" placeholder="CNPJ ou CPF" class="w-full p-2 border rounded">
        <input id="fornecedorEmail" placeholder="E-mail" class="w-full p-2 border rounded">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button>
      </form>
      <table class="w-full bg-white shadow rounded">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2">Nome</th>
            <th>Telefone</th>
            <th>CNPJ/CPF</th>
            <th>Email</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="listaFornecedores"></tbody>
      </table>
    </section>

    <!-- UPLOAD UPSELLER -->
    <section id="upload" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Upload Planilha UPSELLER</h2>
      <input type="file" id="fileUpload" class="mb-4">
      <button onclick="processarPlanilha()" class="bg-green-600 text-white px-4 py-2 rounded">Processar Planilha</button>
      <div id="resultadoUpload" class="mt-4"></div>
    </section>

  </main>

  <!-- SCRIPT -->
  <script>
    // ====== CONFIG: Supabase ======
    const SUPABASE_URL = "https://ifkounurhfzwypnkywzz.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlma291bnVyaGZ6d3lwbmt5d3p6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MjczMDQsImV4cCI6MjA3MTIwMzMwNH0.0yHrecXrnPByyP2gFFvRI76r918Q4VQZxuHq7xz_neI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ====== TROCA DE SE√á√ïES ======
    function mostrar(secao) {
      document.querySelectorAll("main section").forEach(s => s.classList.add("hidden"));
      document.getElementById(secao).classList.remove("hidden");
      if (secao === "dashboard") carregarDashboard();
      if (secao === "produtos") carregarProdutos();
      if (secao === "fornecedores") carregarFornecedores();
    }
    mostrar("dashboard");

    // ====== PRODUTOS CRUD ======
    async function carregarProdutos() {
      const { data } = await supabase.from("produtos").select("*");
      const lista = document.getElementById("listaProdutos");
      lista.innerHTML = "";
      data.forEach(p => {
        lista.innerHTML += `
          <tr>
            <td>${p.sku}</td>
            <td>${p.nome}</td>
            <td>${p.quantidade}</td>
            <td>R$ ${p.preco_venda}</td>
            <td>
              <button onclick="editarProduto(${p.id})" class="text-blue-600">Editar</button>
              <button onclick="deletarProduto(${p.id})" class="text-red-600">Excluir</button>
            </td>
          </tr>`;
      });
    }

    document.getElementById("formProduto").addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("produtoId").value;
      const produto = {
        sku: sku.value, nome: nome.value, categoria: categoria.value,
        cor: cor.value, tamanho: tamanho.value, quantidade: parseInt(quantidade.value),
        preco_fornecedor: parseFloat(precoFornecedor.value), preco_venda: parseFloat(precoVenda.value)
      };
      if (id) await supabase.from("produtos").update(produto).eq("id", id);
      else await supabase.from("produtos").insert([produto]);
      e.target.reset();
      document.getElementById("produtoId").value = "";
      carregarProdutos();
    });

    async function editarProduto(id) {
      const { data } = await supabase.from("produtos").select("*").eq("id", id).single();
      if (data) {
        produtoId.value = data.id;
        sku.value = data.sku;
        nome.value = data.nome;
        categoria.value = data.categoria;
        cor.value = data.cor;
        tamanho.value = data.tamanho;
        quantidade.value = data.quantidade;
        precoFornecedor.value = data.preco_fornecedor;
        precoVenda.value = data.preco_venda;
      }
    }
    async function deletarProduto(id) {
      if (confirm("Excluir produto?")) {
        await supabase.from("produtos").delete().eq("id", id);
        carregarProdutos();
      }
    }

    // ====== FORNECEDORES CRUD ======
    async function carregarFornecedores() {
      const { data } = await supabase.from("fornecedores").select("*");
      const lista = document.getElementById("listaFornecedores");
      lista.innerHTML = "";
      data.forEach(f => {
        lista.innerHTML += `
          <tr>
            <td>${f.nome}</td>
            <td>${f.telefone}</td>
            <td>${f.cnpj_cpf}</td>
            <td>${f.email}</td>
            <td>
              <button onclick="editarFornecedor(${f.id})" class="text-blue-600">Editar</button>
              <button onclick="deletarFornecedor(${f.id})" class="text-red-600">Excluir</button>
            </td>
          </tr>`;
      });
    }

    document.getElementById("formFornecedor").addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = fornecedorId.value;
      const fornecedor = {
        nome: fornecedorNome.value,
        telefone: fornecedorTelefone.value,
        cnpj_cpf: fornecedorCnpjCpf.value,
        email: fornecedorEmail.value
      };
      if (id) await supabase.from("fornecedores").update(fornecedor).eq("id", id);
      else await supabase.from("fornecedores").insert([fornecedor]);
      e.target.reset();
      fornecedorId.value = "";
      carregarFornecedores();
    });

    async function editarFornecedor(id) {
      const { data } = await supabase.from("fornecedores").select("*").eq("id", id).single();
      if (data) {
        fornecedorId.value = data.id;
        fornecedorNome.value = data.nome;
        fornecedorTelefone.value = data.telefone;
        fornecedorCnpjCpf.value = data.cnpj_cpf;
        fornecedorEmail.value = data.email;
      }
    }
    async function deletarFornecedor(id) {
      if (confirm("Excluir fornecedor?")) {
        await supabase.from("fornecedores").delete().eq("id", id);
        carregarFornecedores();
      }
    }

    // ====== UPLOAD PLANILHA UPSELLER ======
    async function processarPlanilha() {
      const file = document.getElementById("fileUpload").files[0];
      if (!file) { alert("Selecione uma planilha!"); return; }
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data);
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet);

      let sucessos = 0, falhas = 0;
      for (const row of rows) {
        const sku = row.SKU;
        const nomeProduto = row["Nome do An√∫ncio"];
        const variacao = row["Varia√ß√£o"] || "";
        const precoVenda = row["Pre√ßo de Produto"] || 0;
        const quantidade = row["Qtd. do Produto"] || 0;

        try {
          // Verifica se produto existe
          let { data: prod } = await supabase.from("produtos").select("*").eq("sku", sku).single();
          if (!prod) {
            // Se n√£o existir, cria produto
            await supabase.from("produtos").insert([{
              sku: sku,
              nome: nomeProduto,
              categoria: "UPSELLER",
              cor: variacao.split(",")[0] || "",
              tamanho: variacao.split(",")[1] || "",
              quantidade: 0,
              preco_fornecedor: 0,
              preco_venda: precoVenda
            }]);
          }
          // Chama RPC registrar_venda
          await supabase.rpc("registrar_venda", {
            p_produto_sku: sku,
            p_quantidade: parseInt(quantidade),
            p_preco: parseFloat(precoVenda),
            p_descricao: "Venda UPSELLER"
          });
          sucessos++;
        } catch (err) {
          console.error("Falha:", row, err);
          falhas++;
        }
      }
      document.getElementById("resultadoUpload").innerHTML = `
        <p class="text-green-600">Sucessos: ${sucessos}</p>
        <p class="text-red-600">Falhas: ${falhas}</p>`;
    }

  </script>
</body>
</html>
