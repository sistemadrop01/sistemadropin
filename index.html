<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>DROP ERP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 flex">

  <!-- Sidebar -->
  <aside class="w-64 bg-gray-900 text-white min-h-screen p-4">
    <h1 class="text-2xl font-bold mb-8">DROP ERP</h1>
    <nav class="space-y-2">
      <button onclick="mostrar('dashboard')" class="w-full text-left p-2 rounded hover:bg-gray-700">üìä Dashboard</button>
      <button onclick="mostrar('produtos')" class="w-full text-left p-2 rounded hover:bg-gray-700">üì¶ Produtos</button>
      <button onclick="mostrar('upload')" class="w-full text-left p-2 rounded hover:bg-gray-700">üìÇ Upload UPSELLER</button>
    </nav>
  </aside>

  <!-- Conte√∫do -->
  <main class="flex-1 p-6 space-y-6">

    <!-- DASHBOARD -->
    <section id="dashboard">
      <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
      <div class="grid grid-cols-3 gap-4">
        <div class="bg-white shadow rounded-lg p-4 text-center">
          <p class="text-gray-500">Produtos</p>
          <h3 id="qtdProdutos" class="text-2xl font-bold">0</h3>
        </div>
        <div class="bg-white shadow rounded-lg p-4 text-center">
          <p class="text-gray-500">Vendas na Semana</p>
          <h3 id="vendasSemana" class="text-2xl font-bold">0</h3>
        </div>
        <div class="bg-white shadow rounded-lg p-4 text-center">
          <p class="text-gray-500">Financeiro</p>
          <h3 id="saldoFinanceiro" class="text-2xl font-bold">R$ 0,00</h3>
        </div>
      </div>
    </section>

    <!-- PRODUTOS -->
    <section id="produtos" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Gerenciar Produtos</h2>
      <form id="formProduto" class="space-y-4 max-w-2xl mb-6 bg-white p-4 rounded shadow">
        <input type="hidden" id="produtoId">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <div>
            <label class="text-sm text-gray-600">SKU</label>
            <input id="sku" placeholder="Ex: CAMIS-ML-PT-M" class="w-full p-2 border rounded">
          </div>
          <div>
            <label class="text-sm text-gray-600">Modelo</label>
            <select id="modelo" class="w-full p-2 border rounded">
              <option value="Camiseta">Camiseta</option>
              <option value="Moletom">Moletom</option>
              <option value="Cal√ßa">Cal√ßa</option>
              <option value="Cal√ßado">Cal√ßado</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-gray-600">Categoria</label>
            <input id="categoria" placeholder="Ex: Esportiva, Casual" class="w-full p-2 border rounded">
          </div>
          <div>
            <label class="text-sm text-gray-600">Quantidade</label>
            <input type="number" id="quantidade" placeholder="0" class="w-full p-2 border rounded">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-gray-600">Pre√ßo Fornecedor</label>
            <input type="number" step="0.01" id="preco_fornecedor" placeholder="0.00" class="w-full p-2 border rounded">
          </div>
          <div>
            <label class="text-sm text-gray-600">Pre√ßo Venda</label>
            <input type="number" step="0.01" id="preco_venda" placeholder="0.00" class="w-full p-2 border rounded">
          </div>
        </div>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button>
      </form>

      <table class="min-w-full bg-white rounded shadow">
        <thead>
          <tr class="bg-gray-200 text-left">
            <th class="p-2">SKU</th>
            <th class="p-2">Modelo</th>
            <th class="p-2">Categoria</th>
            <th class="p-2">Qtd</th>
            <th class="p-2">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="listaProdutos"></tbody>
      </table>
    </section>

    <!-- UPLOAD UPSELLER -->
    <section id="upload" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Upload Planilha UPSELLER</h2>
      <input type="file" id="fileUpload" class="mb-4">
      <button onclick="processarPlanilha()" class="bg-green-600 text-white px-4 py-2 rounded">Processar</button>
      <div id="resultadoUpload" class="mt-4"></div>
    </section>

  </main>

  <script>
   // ====== CONFIG: Supabase ======
    const SUPABASE_URL = "https://ifkounurhfzwypnkywzz.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlma291bnVyaGZ6d3lwbmt5d3p6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MjczMDQsImV4cCI6MjA3MTIwMzMwNH0.0yHrecXrnPByyP2gFFvRI76r918Q4VQZxuHq7xz_neI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // troca de se√ß√£o
    function mostrar(secao) {
      document.querySelectorAll("main section").forEach(s => s.classList.add("hidden"));
      document.getElementById(secao).classList.remove("hidden");
      if (secao === "produtos") carregarProdutos();
    }

    // PRODUTOS
    document.getElementById("formProduto").addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("produtoId").value;
      const sku = document.getElementById("sku").value;
      const modelo = document.getElementById("modelo").value;
      const categoria = document.getElementById("categoria").value;
      const quantidade = parseInt(document.getElementById("quantidade").value) || 0;
      const preco_fornecedor = parseFloat(document.getElementById("preco_fornecedor").value) || 0;
      const preco_venda = parseFloat(document.getElementById("preco_venda").value) || 0;

      if (id) {
        await supabase.from("produtos").update({ sku, modelo, categoria, quantidade, preco_fornecedor, preco_venda }).eq("id", id);
        alert("Produto atualizado!");
      } else {
        await supabase.from("produtos").insert([{ sku, modelo, categoria, quantidade, preco_fornecedor, preco_venda }]);
        alert("Produto cadastrado!");
      }

      e.target.reset();
      document.getElementById("produtoId").value = "";
      carregarProdutos();
    });

    async function carregarProdutos() {
      const { data } = await supabase.from("produtos").select("*");
      const tbody = document.getElementById("listaProdutos");
      tbody.innerHTML = "";
      data.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="p-2">${p.sku}</td>
          <td class="p-2">${p.modelo}</td>
          <td class="p-2">${p.categoria}</td>
          <td class="p-2">${p.quantidade}</td>
          <td class="p-2">
            <button onclick="editarProduto('${p.id}','${p.sku}','${p.modelo}','${p.categoria}','${p.quantidade}','${p.preco_fornecedor}','${p.preco_venda}')" class="text-blue-600">‚úèÔ∏è</button>
            <button onclick="deletarProduto('${p.id}')" class="text-red-600">üóëÔ∏è</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function editarProduto(id, sku, modelo, categoria, quantidade, preco_fornecedor, preco_venda) {
      document.getElementById("produtoId").value = id;
      document.getElementById("sku").value = sku;
      document.getElementById("modelo").value = modelo;
      document.getElementById("categoria").value = categoria;
      document.getElementById("quantidade").value = quantidade;
      document.getElementById("preco_fornecedor").value = preco_fornecedor;
      document.getElementById("preco_venda").value = preco_venda;
    }

    async function deletarProduto(id) {
      if (confirm("Excluir produto?")) {
        await supabase.from("produtos").delete().eq("id", id);
        carregarProdutos();
      }
    }

    // UPSELLER
    async function processarPlanilha() {
      const file = document.getElementById("fileUpload").files[0];
      if (!file) { alert("Selecione uma planilha!"); return; }

      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data);
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet);

      let sucessos = 0, falhas = 0;

      for (const row of rows) {
        const sku = row.SKU || row.sku;
        const quantidade = row.Quantidade || row.qtd || row["Qtd. do Produto"];

        if (sku && quantidade) {
          try {
            await supabase.rpc("registrar_venda", { 
              p_produto_id: (await buscarProdutoIdPorSku(sku)), 
              p_quantidade: parseInt(quantidade), 
              p_preco: 0,
              p_descricao: "Venda UPSELLER"
            });
            sucessos++;
          } catch (err) {
            console.error("Falha:", row, err);
            falhas++;
          }
        } else {
          falhas++;
        }
      }

      document.getElementById("resultadoUpload").innerHTML = `
        <p class="text-green-600">Sucessos: ${sucessos}</p>
        <p class="text-red-600">Falhas: ${falhas}</p>
      `;
    }

    async function buscarProdutoIdPorSku(sku) {
      const { data, error } = await supabase.from("produtos").select("id").eq("sku", sku).single();
      if (error || !data) throw new Error(`Produto n√£o encontrado: ${sku}`);
      return data.id;
    }
  </script>
</body>
</html>
